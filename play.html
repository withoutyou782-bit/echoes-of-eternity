<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of Eternity - –ñ–∏–≤–æ–π –º–∏—Ä RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        #game-container {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            text-align: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 10px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="loading" class="pulse">
        <div>üåü Echoes of Eternity üåü</div>
        <div style="font-size: 16px; margin-top: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div id="game-container"></div>
    
    <!-- Phaser 3 –∏–∑ CDN —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js" 
            onerror="this.onerror=null; this.src='https://cdnjs.cloudflare.com/ajax/libs/phaser/3.70.0/phaser.min.js'"></script>
    
    <script>
        console.log('Starting game initialization...');
        
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        window.gameState = {
            playerName: '–°—Ç—Ä–∞–Ω–Ω–∏–∫',
            level: 1,
            hp: 100,
            maxHp: 100,
            mp: 50,
            maxMp: 50,
            exp: 0,
            gold: 100,
            inventory: [],
            quests: [],
            reputation: {
                guardians: 0,
                rebels: 0,
                merchants: 0,
                mystics: 0
            },
            flags: {},
            relationships: {},
            timeOfDay: 'morning',
            weather: 'clear',
            worldState: {
                npcStates: {},
                discoveredLocations: [],
                completedQuests: [],
                choices: []
            }
        };

        // MenuScene - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        class MenuScene extends Phaser.Scene {
            constructor() {
                super({ key: 'MenuScene' });
            }

            create() {
                console.log('MenuScene created');
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                // –§–æ–Ω
                const bg = this.add.graphics();
                bg.fillGradientStyle(0x1a1a2e, 0x1a1a2e, 0x0f3460, 0x0f3460, 1);
                bg.fillRect(0, 0, width, height);

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                this.add.text(width / 2, height / 4, 'üåü ECHOES OF ETERNITY üåü', {
                    fontFamily: 'Courier New',
                    fontSize: '48px',
                    color: '#00ffff',
                    stroke: '#000000',
                    strokeThickness: 4
                }).setOrigin(0.5);

                this.add.text(width / 2, height / 4 + 60, '–ñ–∏–≤–æ–π –º–∏—Ä RPG', {
                    fontFamily: 'Courier New',
                    fontSize: '24px',
                    color: '#ffffff',
                    fontStyle: 'italic'
                }).setOrigin(0.5);

                // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
                const buttonY = height / 2 + 50;
                const buttonSpacing = 70;

                this.createButton(width / 2, buttonY, '‚ñ∂ –ù–û–í–ê–Ø –ò–ì–†–ê', () => {
                    console.log('Starting new game...');
                    this.scene.start('WorldScene');
                    this.scene.launch('UIScene');
                });

                this.createButton(width / 2, buttonY + buttonSpacing, 'üìñ –ü–†–û–î–û–õ–ñ–ò–¢–¨', () => {
                    this.showMessage('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç');
                });

                this.createButton(width / 2, buttonY + buttonSpacing * 2, '‚öô –ù–ê–°–¢–†–û–ô–ö–ò', () => {
                    this.showMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                });

                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–Ω–∏–∑—É
                this.add.text(width / 2, height - 30, 'v1.0.0 | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –°—Ç—Ä–µ–ª–∫–∏, ESC - –º–µ–Ω—é', {
                    fontFamily: 'Courier New',
                    fontSize: '14px',
                    color: '#888888'
                }).setOrigin(0.5);
            }

            createButton(x, y, text, callback) {
                const button = this.add.text(x, y, text, {
                    fontFamily: 'Courier New',
                    fontSize: '24px',
                    color: '#ffffff',
                    backgroundColor: '#16213e',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setInteractive();

                button.on('pointerover', () => {
                    button.setStyle({ color: '#00ffff', backgroundColor: '#0f3460' });
                    button.setScale(1.05);
                });

                button.on('pointerout', () => {
                    button.setStyle({ color: '#ffffff', backgroundColor: '#16213e' });
                    button.setScale(1);
                });

                button.on('pointerdown', callback);

                return button;
            }

            showMessage(text) {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;
                
                const msg = this.add.text(width / 2, height / 2, text, {
                    fontFamily: 'Courier New',
                    fontSize: '20px',
                    color: '#ffffff',
                    backgroundColor: '#000000',
                    padding: { x: 30, y: 20 }
                }).setOrigin(0.5).setDepth(1000);

                this.time.delayedCall(2000, () => msg.destroy());
            }
        }

        // WorldScene - –ò–≥—Ä–æ–≤–æ–π –º–∏—Ä
        class WorldScene extends Phaser.Scene {
            constructor() {
                super({ key: 'WorldScene' });
                this.encounterTimer = 0;
                this.encounterChance = 0.02;
            }

            create() {
                console.log('WorldScene created');
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                // –°–æ–∑–¥–∞—ë–º –±–æ–ª—å—à–æ–π –º–∏—Ä
                this.worldWidth = 2000;
                this.worldHeight = 1500;

                // –§–æ–Ω –º–∏—Ä–∞
                this.bg = this.add.graphics();
                this.bg.fillGradientStyle(0x2d4a3e, 0x2d4a3e, 0x1a2f23, 0x1a2f23, 1);
                this.bg.fillRect(0, 0, this.worldWidth, this.worldHeight);

                // –ó–æ–Ω—ã –º–∏—Ä–∞
                this.createZones();

                // –ò–≥—Ä–æ–∫ —Å —Ñ–∏–∑–∏–∫–æ–π
                this.player = this.physics.add.sprite(width / 2, height / 2, null);
                this.player.setCollideWorldBounds(true);
                this.player.setSize(30, 30);
                this.player.setDepth(100);
                
                // –í–∏–∑—É–∞–ª –∏–≥—Ä–æ–∫–∞
                this.playerGraphics = this.add.graphics();
                this.updatePlayerGraphics();

                // –ö–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
                this.cameras.main.setBounds(0, 0, this.worldWidth, this.worldHeight);
                this.cameras.main.startFollow(this.player, true, 0.1, 0.1);

                // NPC —Å –∫–≤–µ—Å—Ç–∞–º–∏
                this.npcs = [];
                this.createNPC(300, 300, 'üë§', '–°—Ç–∞—Ä–µ–π—à–∏–Ω–∞', [
                    { text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Å—Ç—Ä–∞–Ω–Ω–∏–∫!', responses: [
                        { text: '–†–∞—Å—Å–∫–∞–∂–∏ –æ –≥–æ—Ä–æ–¥–µ', next: 1 },
                        { text: '–ï—Å—Ç—å –ª–∏ –∑–∞–¥–∞–Ω–∏—è?', quest: 'find_artifact' }
                    ]},
                    { text: '–ù–∞—à –≥–æ—Ä–æ–¥ –¥—Ä–µ–≤–Ω–∏–π. –ó–¥–µ—Å—å –º–Ω–æ–≥–æ —Ç–∞–π–Ω...', responses: [
                        { text: '–°–ø–∞—Å–∏–±–æ', end: true }
                    ]}
                ]);
                
                this.createNPC(600, 400, '‚öîÔ∏è', '–í–æ–∏–Ω', [
                    { text: '–•–æ—á–µ—à—å –Ω–∞—É—á–∏—Ç—å—Å—è —Å—Ä–∞–∂–∞—Ç—å—Å—è?', responses: [
                        { text: '–î–∞, –Ω–∞—É—á–∏ –º–µ–Ω—è!', quest: 'training' },
                        { text: '–ú–æ–∂–µ—Ç –ø–æ–∑–∂–µ', end: true }
                    ]}
                ]);
                
                this.createNPC(900, 500, 'üßô', '–ú—É–¥—Ä–µ—Ü', [
                    { text: '–Ø –≤–∏–∂—É –≤ —Ç–µ–±–µ –≤–µ–ª–∏–∫—É—é —Å–∏–ª—É...', responses: [
                        { text: '–ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å?', next: 1 },
                        { text: '–£–π—Ç–∏', end: true }
                    ]},
                    { text: '–¢—ë–º–Ω—ã–µ —Å–∏–ª—ã –ø—Ä–æ–±—É–∂–¥–∞—é—Ç—Å—è. –ë—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω!', responses: [
                        { text: '–Ø –≥–æ—Ç–æ–≤', end: true }
                    ]}
                ]);

                this.createNPC(400, 700, 'üëß', '–î–µ–≤–æ—á–∫–∞', [
                    { text: '–¢—ã –≤–∏–¥–µ–ª –º–æ–µ–≥–æ –∫–æ—Ç–∞? –û–Ω —É–±–µ–∂–∞–ª –≤ –ª–µ—Å...', responses: [
                        { text: '–Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –µ–≥–æ', quest: 'find_cat' },
                        { text: '–ò–∑–≤–∏–Ω–∏, —Å–ø–µ—à—É', end: true }
                    ]}
                ]);

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                this.cursors = this.input.keyboard.createCursorKeys();
                this.wasd = {
                    up: this.input.keyboard.addKey('W'),
                    down: this.input.keyboard.addKey('S'),
                    left: this.input.keyboard.addKey('A'),
                    right: this.input.keyboard.addKey('D')
                };
                this.interactKey = this.input.keyboard.addKey('Z');
                this.shiftKey = this.input.keyboard.addKey('SHIFT');

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–æ–Ω—ã
                this.zoneText = this.add.text(10, 10, '', {
                    fontFamily: 'Courier New',
                    fontSize: '18px',
                    color: '#ffffff',
                    backgroundColor: '#000000aa',
                    padding: { x: 10, y: 5 }
                }).setScrollFactor(0).setDepth(200);

                // –ü–æ–¥—Å–∫–∞–∑–∫–∞
                this.hintText = this.add.text(width / 2, height - 30, '', {
                    fontFamily: 'Courier New',
                    fontSize: '14px',
                    color: '#ffff00',
                    backgroundColor: '#000000aa',
                    padding: { x: 10, y: 5 }
                }).setOrigin(0.5).setScrollFactor(0).setDepth(200);
            }

            createZones() {
                // –°–æ–∑–¥–∞—ë–º —Ä–∞–∑–Ω—ã–µ –∑–æ–Ω—ã –º–∏—Ä–∞
                this.zones = [
                    { name: '–ì–æ—Ä–æ–¥', x: 0, y: 0, width: 800, height: 600, color: 0x3a5a4a, enemies: [] },
                    { name: '–õ–µ—Å', x: 800, y: 0, width: 600, height: 800, color: 0x2d4a3e, enemies: ['slime', 'wolf', 'spider'] },
                    { name: '–ü–µ—â–µ—Ä–∞', x: 0, y: 600, width: 800, height: 900, color: 0x1a2f23, enemies: ['bat', 'skeleton', 'ghost'] },
                    { name: '–¢—ë–º–Ω—ã–π –ª–µ—Å', x: 800, y: 800, width: 1200, height: 700, color: 0x0f1f13, enemies: ['demon', 'dragon', 'wraith'] }
                ];

                // –†–∏—Å—É–µ–º –∑–æ–Ω—ã
                this.zones.forEach(zone => {
                    const graphics = this.add.graphics();
                    graphics.fillStyle(zone.color, 1);
                    graphics.fillRect(zone.x, zone.y, zone.width, zone.height);
                    
                    // –ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã
                    this.add.text(zone.x + zone.width/2, zone.y + 30, zone.name, {
                        fontSize: '24px',
                        color: '#ffffff',
                        fontFamily: 'Courier New',
                        stroke: '#000000',
                        strokeThickness: 3
                    }).setOrigin(0.5);
                });
            }

            updatePlayerGraphics() {
                this.playerGraphics.clear();
                this.playerGraphics.fillStyle(0x00ff00, 1);
                this.playerGraphics.fillCircle(this.player.x, this.player.y, 15);
                this.playerGraphics.lineStyle(2, 0xffffff);
                this.playerGraphics.strokeCircle(this.player.x, this.player.y, 15);
            }

            createNPC(x, y, sprite, name, dialogue) {
                const npc = this.add.container(x, y);
                const body = this.add.circle(0, 0, 20, 0xffaa00);
                const icon = this.add.text(0, 0, sprite, { fontSize: '32px' }).setOrigin(0.5);
                const nameText = this.add.text(0, 35, name, {
                    fontSize: '12px',
                    color: '#ffffff',
                    fontFamily: 'Courier New',
                    backgroundColor: '#000000aa',
                    padding: { x: 5, y: 2 }
                }).setOrigin(0.5);
                
                npc.add([body, icon, nameText]);
                npc.setData('name', name);
                npc.setData('dialogue', dialogue);
                npc.setData('sprite', sprite);
                
                this.npcs.push(npc);
            }

            update(time, delta) {
                if (!this.player) return;

                // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
                const speed = this.shiftKey.isDown ? 300 : 150;
                this.player.setVelocity(0);

                if (this.cursors.left.isDown || this.wasd.left.isDown) {
                    this.player.setVelocityX(-speed);
                } else if (this.cursors.right.isDown || this.wasd.right.isDown) {
                    this.player.setVelocityX(speed);
                }

                if (this.cursors.up.isDown || this.wasd.up.isDown) {
                    this.player.setVelocityY(-speed);
                } else if (this.cursors.down.isDown || this.wasd.down.isDown) {
                    this.player.setVelocityY(speed);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫—É –∏–≥—Ä–æ–∫–∞
                this.updatePlayerGraphics();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–æ–Ω—ã
                this.checkZone();

                // –°–ª—É—á–∞–π–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏ —Å –≤—Ä–∞–≥–∞–º–∏
                if (this.player.body.velocity.length() > 0) {
                    this.encounterTimer += delta;
                    if (this.encounterTimer > 1000) {
                        this.encounterTimer = 0;
                        this.checkEncounter();
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ NPC
                this.checkNPCProximity();

                // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å NPC
                if (Phaser.Input.Keyboard.JustDown(this.interactKey)) {
                    this.interactWithNPC();
                }
            }

            checkZone() {
                const currentZone = this.zones.find(zone => 
                    this.player.x >= zone.x && 
                    this.player.x <= zone.x + zone.width &&
                    this.player.y >= zone.y && 
                    this.player.y <= zone.y + zone.height
                );

                if (currentZone && currentZone.name !== window.gameState.currentZone) {
                    window.gameState.currentZone = currentZone.name;
                    this.zoneText.setText(`üìç ${currentZone.name}`);
                    this.showMessage(`–í—ã –≤–æ—à–ª–∏ –≤: ${currentZone.name}`);
                }
            }

            checkEncounter() {
                const currentZone = this.zones.find(zone => 
                    this.player.x >= zone.x && 
                    this.player.x <= zone.x + zone.width &&
                    this.player.y >= zone.y && 
                    this.player.y <= zone.y + zone.height
                );

                if (currentZone && currentZone.enemies.length > 0 && Math.random() < this.encounterChance) {
                    const enemyType = Phaser.Utils.Array.GetRandom(currentZone.enemies);
                    this.startBattle(enemyType);
                }
            }

            startBattle(enemyType) {
                const enemies = {
                    slime: { 
                        id: 'slime',
                        name: '–°–ª–∏–∑–µ–Ω—å', 
                        sprite: 'üü¢', 
                        hp: 30, 
                        maxHp: 30, 
                        exp: 15, 
                        gold: 10,
                        attacks: ['basic', 'wave'],
                        talkResponses: ['*–ë—É–ª—å–∫–∞–µ—Ç*', '–°–ª–∏–∑–µ–Ω—å –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –≤–∞—Å...']
                    },
                    wolf: { 
                        id: 'wolf',
                        name: '–í–æ–ª–∫', 
                        sprite: 'üê∫', 
                        hp: 50, 
                        maxHp: 50, 
                        exp: 25, 
                        gold: 15,
                        attacks: ['basic', 'cross'],
                        talkResponses: ['*–†—ã—á–∏—Ç*', '–í–æ–ª–∫ –≥–æ—Ç–æ–≤ –∞—Ç–∞–∫–æ–≤–∞—Ç—å!']
                    },
                    spider: { 
                        id: 'spider',
                        name: '–ü–∞—É–∫', 
                        sprite: 'üï∑Ô∏è', 
                        hp: 40, 
                        maxHp: 40, 
                        exp: 20, 
                        gold: 12,
                        attacks: ['spiral', 'wave'],
                        rareAttack: 'meteor',
                        talkResponses: ['*–®–∏–ø–∏—Ç*', '–ü–∞—É–∫ –ø–ª–µ—Ç—ë—Ç –ø–∞—É—Ç–∏–Ω—É...']
                    },
                    bat: { 
                        id: 'bat',
                        name: '–õ–µ—Ç—É—á–∞—è –º—ã—à—å', 
                        sprite: 'ü¶á', 
                        hp: 35, 
                        maxHp: 35, 
                        exp: 18, 
                        gold: 8,
                        attacks: ['spiral', 'cross'],
                        talkResponses: ['*–ü–∏—â–∏—Ç*', '–ú—ã—à—å –∫—Ä—É–∂–∏—Ç –≤–æ–∫—Ä—É–≥ –≤–∞—Å...']
                    },
                    skeleton: { 
                        id: 'skeleton',
                        name: '–°–∫–µ–ª–µ—Ç', 
                        sprite: 'üíÄ', 
                        hp: 60, 
                        maxHp: 60, 
                        exp: 30, 
                        gold: 20,
                        attacks: ['cross', 'wave'],
                        talkResponses: ['*–ö–æ—Å—Ç—è–Ω–æ–π —Å—Ç—É–∫*', '–°–∫–µ–ª–µ—Ç –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∞—Ç–∞–∫–æ–≤–∞—Ç—å!']
                    },
                    ghost: { 
                        id: 'ghost',
                        name: '–ü—Ä–∏–∑—Ä–∞–∫', 
                        sprite: 'üëª', 
                        hp: 45, 
                        maxHp: 45, 
                        exp: 22, 
                        gold: 15,
                        attacks: ['spiral', 'wave'],
                        rareAttack: 'meteor',
                        talkResponses: ['*–ñ—É—Ç–∫–∏–π –≤–æ–π*', '–ü—Ä–∏–∑—Ä–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–∫–≤–æ–∑—å —Å—Ç–µ–Ω—ã...']
                    },
                    demon: { 
                        id: 'demon',
                        name: '–î–µ–º–æ–Ω', 
                        sprite: 'üòà', 
                        hp: 80, 
                        maxHp: 80, 
                        exp: 50, 
                        gold: 30,
                        attacks: ['cross', 'spiral', 'wave'],
                        rareAttack: 'meteor',
                        talkResponses: ['–¢–≤–æ—è –¥—É—à–∞ –º–æ—è!', '–î–µ–º–æ–Ω —Å–º–µ—ë—Ç—Å—è –∑–ª–æ–≤–µ—â–µ...']
                    },
                    dragon: { 
                        id: 'dragon',
                        name: '–î—Ä–∞–∫–æ–Ω', 
                        sprite: 'üêâ', 
                        hp: 120, 
                        maxHp: 120, 
                        exp: 100, 
                        gold: 50,
                        attacks: ['meteor', 'cross', 'spiral'],
                        rareAttack: 'meteor',
                        talkResponses: ['*–û–≥–Ω–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ*', '–î—Ä–∞–∫–æ–Ω —Ä–∞—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä—ã–ª—å—è!']
                    },
                    wraith: { 
                        id: 'wraith',
                        name: '–¢—ë–º–Ω—ã–π –ø—Ä–∏–∑—Ä–∞–∫', 
                        sprite: 'üë§', 
                        hp: 70, 
                        maxHp: 70, 
                        exp: 40, 
                        gold: 25,
                        attacks: ['spiral', 'cross', 'wave'],
                        rareAttack: 'meteor',
                        talkResponses: ['–¢—å–º–∞ –ø–æ–≥–ª–æ—Ç–∏—Ç —Ç–µ–±—è...', '–ü—Ä–∏–∑—Ä–∞–∫ –∏—Å—á–µ–∑–∞–µ—Ç –∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è...']
                    }
                };

                const enemy = enemies[enemyType];
                if (enemy) {
                    this.scene.pause();
                    this.scene.launch('BattleScene', { enemy });
                }
            }

            checkNPCProximity() {
                let nearestNPC = null;
                let minDist = 100;

                this.npcs.forEach(npc => {
                    const dist = Phaser.Math.Distance.Between(
                        this.player.x, this.player.y,
                        npc.x, npc.y
                    );

                    if (dist < minDist) {
                        minDist = dist;
                        nearestNPC = npc;
                    }
                });

                if (nearestNPC && minDist < 60) {
                    this.hintText.setText(`[Z] –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å ${nearestNPC.getData('name')}`);
                    this.nearestNPC = nearestNPC;
                } else {
                    this.hintText.setText('');
                    this.nearestNPC = null;
                }
            }

            interactWithNPC() {
                if (!this.nearestNPC) return;

                const dialogue = this.nearestNPC.getData('dialogue');
                const name = this.nearestNPC.getData('name');
                
                this.startDialogue(name, dialogue, 0);
            }

            startDialogue(name, dialogueTree, index) {
                this.scene.pause();
                
                const dialogue = dialogueTree[index];
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                // –î–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ
                const dialogBox = this.add.container(width/2, height - 150);
                dialogBox.setScrollFactor(0).setDepth(1000);

                const bg = this.add.rectangle(0, 0, width - 100, 200, 0x000000, 0.95);
                bg.setStrokeStyle(4, 0x00ffff);

                const nameText = this.add.text(-width/2 + 70, -70, name, {
                    fontSize: '20px',
                    color: '#00ffff',
                    fontFamily: 'Courier New',
                    fontStyle: 'bold'
                });

                const dialogueText = this.add.text(-width/2 + 70, -40, dialogue.text, {
                    fontSize: '16px',
                    color: '#ffffff',
                    fontFamily: 'Courier New',
                    wordWrap: { width: width - 200 }
                });

                dialogBox.add([bg, nameText, dialogueText]);

                // –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
                if (dialogue.responses) {
                    let yOffset = 20;
                    dialogue.responses.forEach((response, i) => {
                        const responseText = this.add.text(
                            -width/2 + 70,
                            yOffset,
                            `[${i+1}] ${response.text}`,
                            {
                                fontSize: '14px',
                                color: '#ffff00',
                                fontFamily: 'Courier New',
                                backgroundColor: '#222222',
                                padding: { x: 10, y: 5 }
                            }
                        ).setInteractive();

                        responseText.on('pointerover', () => responseText.setBackgroundColor('#444444'));
                        responseText.on('pointerout', () => responseText.setBackgroundColor('#222222'));
                        responseText.on('pointerdown', () => {
                            dialogBox.destroy();
                            
                            if (response.quest) {
                                this.startQuest(response.quest);
                            } else if (response.next !== undefined) {
                                this.startDialogue(name, dialogueTree, response.next);
                                return;
                            }
                            
                            this.scene.resume();
                        });

                        dialogBox.add(responseText);
                        yOffset += 25;
                    });
                } else {
                    const continueText = this.add.text(width/2 - 200, 70, '[Z] –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', {
                        fontSize: '14px',
                        color: '#888888',
                        fontFamily: 'Courier New'
                    });
                    dialogBox.add(continueText);

                    this.input.keyboard.once('keydown-Z', () => {
                        dialogBox.destroy();
                        this.scene.resume();
                    });
                }
            }

            startQuest(questId) {
                const quests = {
                    find_artifact: {
                        id: 'find_artifact',
                        name: '–ù–∞–π—Ç–∏ –¥—Ä–µ–≤–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç',
                        description: '–°—Ç–∞—Ä–µ–π—à–∏–Ω–∞ –ø–æ–ø—Ä–æ—Å–∏–ª –Ω–∞–π—Ç–∏ –¥—Ä–µ–≤–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –≤ —Ä—É–∏–Ω–∞—Ö'
                    },
                    training: {
                        id: 'training',
                        name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –≤–æ–∏–Ω–æ–º',
                        description: '–ü–æ–±–µ–¥–∏—Ç–µ 5 –≤—Ä–∞–≥–æ–≤ —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É'
                    },
                    find_cat: {
                        id: 'find_cat',
                        name: '–ù–∞–π—Ç–∏ –∫–æ—Ç–∞',
                        description: '–î–µ–≤–æ—á–∫–∞ –ø–æ—Ç–µ—Ä—è–ª–∞ –∫–æ—Ç–∞ –≤ –ª–µ—Å—É. –ü–æ–º–æ–≥–∏—Ç–µ –Ω–∞–π—Ç–∏ –µ–≥–æ!'
                    }
                };

                const quest = quests[questId];
                if (quest && !window.gameState.activeQuests.find(q => q.id === questId)) {
                    window.gameState.activeQuests.push(quest);
                    this.showMessage(`üìú –ù–æ–≤—ã–π –∫–≤–µ—Å—Ç: ${quest.name}`);
                }
            }

            showMessage(text, duration = 2000) {
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                const msg = this.add.text(width/2, height/2, text, {
                    fontSize: '20px',
                    color: '#ffffff',
                    fontFamily: 'Courier New',
                    backgroundColor: '#000000dd',
                    padding: { x: 20, y: 10 }
                }).setOrigin(0.5).setScrollFactor(0).setDepth(999);

                this.time.delayedCall(duration, () => msg.destroy());
            }
                this.playerSpeed = 3;

                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                this.add.text(20, height - 100, 
                    'üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:\n‚Üê ‚Üí - –î–≤–∏–∂–µ–Ω–∏–µ\n–ö–ª–∏–∫ –ø–æ NPC - –î–∏–∞–ª–æ–≥\nESC - –ú–µ–Ω—é', {
                    fontFamily: 'Courier New',
                    fontSize: '14px',
                    color: '#ffffff',
                    backgroundColor: '#00000099',
                    padding: { x: 10, y: 5 }
                });

                // ESC –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
                this.input.keyboard.on('keydown-ESC', () => {
                    console.log('Returning to menu...');
                    this.scene.stop('UIScene');
                    this.scene.start('MenuScene');
                });

                this.dialogueBox = null;
            }

            createNPC(x, y, icon, name, dialogue) {
                const npc = this.add.container(x, y);
                
                const npcBody = this.add.circle(0, 0, 20, 0xff6b6b).setInteractive();
                const npcIcon = this.add.text(0, 0, icon, {
                    fontSize: '32px'
                }).setOrigin(0.5);

                const nameTag = this.add.text(0, -40, name, {
                    fontFamily: 'Courier New',
                    fontSize: '14px',
                    color: '#ffffff',
                    backgroundColor: '#000000',
                    padding: { x: 5, y: 2 }
                }).setOrigin(0.5);

                npc.add([npcBody, npcIcon, nameTag]);

                npcBody.on('pointerover', () => {
                    npcBody.setFillStyle(0xff8888);
                    npc.setScale(1.1);
                });

                npcBody.on('pointerout', () => {
                    npcBody.setFillStyle(0xff6b6b);
                    npc.setScale(1);
                });

                npcBody.on('pointerdown', () => {
                    this.showDialogue(dialogue, name);
                });

                this.npcs.push(npc);
            }

            showDialogue(text, speaker) {
                // –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–∏–∞–ª–æ–≥
                if (this.dialogueBox) {
                    this.dialogueBox.destroy();
                    this.dialogueText.destroy();
                    this.speakerText.destroy();
                }

                const width = this.cameras.main.width;
                const height = this.cameras.main.height;

                this.dialogueBox = this.add.graphics();
                this.dialogueBox.fillStyle(0x000000, 0.95);
                this.dialogueBox.fillRect(50, height - 180, width - 100, 120);
                this.dialogueBox.lineStyle(3, 0x00ffff);
                this.dialogueBox.strokeRect(50, height - 180, width - 100, 120);

                this.speakerText = this.add.text(70, height - 170, speaker + ':', {
                    fontFamily: 'Courier New',
                    fontSize: '18px',
                    color: '#00ffff',
                    fontStyle: 'bold'
                });

                this.dialogueText = this.add.text(70, height - 140, text, {
                    fontFamily: 'Courier New',
                    fontSize: '16px',
                    color: '#ffffff',
                    wordWrap: { width: width - 140 }
                });

                // –ö–ª–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
                this.dialogueBox.setInteractive(
                    new Phaser.Geom.Rectangle(50, height - 180, width - 100, 120),
                    Phaser.Geom.Rectangle.Contains
                );

                this.input.once('pointerdown', () => {
                    if (this.dialogueBox) {
                        this.dialogueBox.destroy();
                        this.dialogueText.destroy();
                        this.speakerText.destroy();
                        this.dialogueBox = null;
                    }
                });

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                this.time.delayedCall(5000, () => {
                    if (this.dialogueBox) {
                        this.dialogueBox.destroy();
                        this.dialogueText.destroy();
                        this.speakerText.destroy();
                        this.dialogueBox = null;
                    }
                });
            }

            update() {
                if (!this.player) return;

                let moved = false;

                if (this.cursors.left.isDown) {
                    this.player.x -= this.playerSpeed;
                    moved = true;
                } else if (this.cursors.right.isDown) {
                    this.player.x += this.playerSpeed;
                    moved = true;
                }

                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü
                const width = this.cameras.main.width;
                const height = this.cameras.main.height;
                this.player.x = Phaser.Math.Clamp(this.player.x, 40, width - 40);
            }
        }

        // UIScene - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        class UIScene extends Phaser.Scene {
            constructor() {
                super({ key: 'UIScene' });
            }

            create() {
                console.log('UIScene created');
                const width = this.cameras.main.width;

                // –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞
                const panel = this.add.graphics();
                panel.fillStyle(0x000000, 0.8);
                panel.fillRect(10, 10, 320, 120);
                panel.lineStyle(2, 0x00ffff);
                panel.strokeRect(10, 10, 320, 120);

                // –ò–º—è –∏–≥—Ä–æ–∫–∞
                this.add.text(20, 20, window.gameState.playerName, {
                    fontFamily: 'Courier New',
                    fontSize: '22px',
                    color: '#00ffff',
                    fontStyle: 'bold'
                });

                // –£—Ä–æ–≤–µ–Ω—å
                this.add.text(20, 50, `–£—Ä–æ–≤–µ–Ω—å: ${window.gameState.level}`, {
                    fontFamily: 'Courier New',
                    fontSize: '16px',
                    color: '#ffffff'
                });

                // HP –±–∞—Ä
                this.add.text(20, 75, '‚ù§Ô∏è HP:', {
                    fontFamily: 'Courier New',
                    fontSize: '14px',
                    color: '#ff6b6b'
                });

                const hpBar = this.add.graphics();
                const hpPercent = window.gameState.hp / window.gameState.maxHp;
                hpBar.fillStyle(0xff0000, 1);
                hpBar.fillRect(75, 77, 200 * hpPercent, 14);
                hpBar.lineStyle(2, 0xffffff);
                hpBar.strokeRect(75, 77, 200, 14);

                this.add.text(285, 75, `${window.gameState.hp}/${window.gameState.maxHp}`, {
                    fontFamily: 'Courier New',
                    fontSize: '12px',
                    color: '#ffffff'
                });

                // MP –±–∞—Ä
                this.add.text(20, 98, 'üíß MP:', {
                    fontFamily: 'Courier New',
                    fontSize: '14px',
                    color: '#6b9eff'
                });

                const mpBar = this.add.graphics();
                const mpPercent = window.gameState.mp / window.gameState.maxMp;
                mpBar.fillStyle(0x0066ff, 1);
                mpBar.fillRect(75, 100, 200 * mpPercent, 14);
                mpBar.lineStyle(2, 0xffffff);
                mpBar.strokeRect(75, 100, 200, 14);

                this.add.text(285, 98, `${window.gameState.mp}/${window.gameState.maxMp}`, {
                    fontFamily: 'Courier New',
                    fontSize: '12px',
                    color: '#ffffff'
                });

                // –ó–æ–ª–æ—Ç–æ
                this.add.text(width - 160, 20, `üí∞ –ó–æ–ª–æ—Ç–æ: ${window.gameState.gold}`, {
                    fontFamily: 'Courier New',
                    fontSize: '18px',
                    color: '#ffd700',
                    backgroundColor: '#00000099',
                    padding: { x: 10, y: 5 }
                });
            }
        }

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
        const config = {
            type: Phaser.AUTO,
            width: 1280,
            height: 720,
            parent: 'game-container',
            backgroundColor: '#1a1a2e',
            scene: [MenuScene, WorldScene, UIScene],
            pixelArt: false,
            antialias: true,
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ Phaser
        function startGame() {
            console.log('Starting game initialization...');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Phaser
            if (typeof Phaser === 'undefined') {
                console.error('Phaser not loaded!');
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #ff6b6b;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>' +
                    '<div style="font-size: 14px; margin-top: 10px;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</div>' +
                    '<div style="font-size: 12px; margin-top: 10px;"><a href="" style="color: #00ffff;">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</a></div>';
                return;
            }

            console.log('Phaser loaded successfully, version:', Phaser.VERSION);
            
            try {
                const game = new Phaser.Game(config);
                console.log('‚úÖ Game instance created successfully');

                // –°–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    const loading = document.getElementById('loading');
                    if (loading) {
                        console.log('Hiding loading screen...');
                        loading.style.transition = 'opacity 0.5s';
                        loading.style.opacity = '0';
                        setTimeout(() => {
                            loading.remove();
                            console.log('‚úÖ Game loaded!');
                        }, 500);
                    }
                }, 1000);
            } catch (error) {
                console.error('‚ùå Error creating game:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #ff6b6b;">‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã</div>' +
                    '<div style="font-size: 14px; margin-top: 10px; color: #fff;">' + error.message + '</div>' +
                    '<div style="font-size: 12px; margin-top: 10px;"><a href="" style="color: #00ffff;">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</a></div>';
            }
        }

        // –ó–∞–ø—É—Å–∫ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ Phaser
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(startGame, 500);
            });
        } else {
            setTimeout(startGame, 500);
        }
    </script>
</body>
</html>
